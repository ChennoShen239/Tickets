<!DOCTYPE html>
<html lang="zh-CN" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>楚楚的奖励兑换券们 (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #10b981;
            --background-color: #f3f4f6;
            --card-background: #ffffff;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
        }

        [data-theme="dark"] {
            --primary-color: #60a5fa;
            --secondary-color: #34d399;
            --background-color: #1f2937;
            --card-background: #374151;
            --text-color: #f3f4f6;
            --border-color: #4b5563;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .coupon-card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .coupon-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        .emoji-container {
            height: 12rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .emoji-container:hover {
            transform: scale(1.05);
        }

        .quantity-change {
            transition: all 0.2s ease;
        }

        .quantity-change:hover {
            transform: scale(1.1);
        }

        .use-coupon {
            transition: all 0.3s ease;
        }

        .use-coupon:hover {
            transform: translateY(-2px);
        }

        /* 日历样式 */
        .calendar { 
            width: 100%; 
            background: var(--card-background); 
            border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); 
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .calendar-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0.75rem 1rem; 
            background-color: var(--background-color); 
            border-bottom: 1px solid var(--border-color); 
        }

        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            gap: 1px; 
            background-color: var(--border-color); 
            border: 1px solid var(--border-color); 
        }

        .calendar-day, .calendar-weekday { 
            padding: 0.5rem; 
            text-align: center; 
            background-color: var(--card-background); 
            font-size: 0.875rem; 
            min-height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative;
            transition: all 0.2s ease;
        }

        .calendar-weekday { 
            font-weight: 600; 
            background-color: var(--background-color); 
        }

        .calendar-day.other-month { 
            color: #9ca3af; 
            background-color: var(--background-color); 
        }

        .calendar-day.today { 
            background-color: var(--primary-color); 
            color: white; 
            font-weight: bold; 
        }

        .calendar-day.selected { 
            background-color: var(--primary-color); 
            color: white; 
            border-radius: 50%; 
            transform: scale(1.1);
        }

        .calendar-day.has-log::after { 
            content: ''; 
            position: absolute; 
            bottom: 4px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 5px; 
            height: 5px; 
            background-color: var(--secondary-color); 
            border-radius: 50%; 
        }

        .calendar-day.selected.has-log::after { 
            background-color: white; 
        }

        .calendar-day:not(.other-month):not(.selected):hover { 
            background-color: var(--background-color); 
            cursor: pointer; 
            border-radius: 50%; 
            transform: scale(1.05);
        }

        .log-area { 
            margin-top: 1.5rem; 
            background: var(--card-background); 
            border-radius: 0.5rem; 
            padding: 1rem; 
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); 
            min-height: 100px; 
            border: 1px solid var(--border-color);
        }

        .log-entry { 
            font-size: 0.875rem; 
            color: var(--text-color); 
            padding: 0.25rem 0; 
            border-bottom: 1px solid var(--border-color); 
        }

        .log-entry:last-child { 
            border-bottom: none; 
        }

        /* 主题切换按钮 */
        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 50;
        }

        .theme-toggle:hover {
            transform: scale(1.05);
        }

        /* 加载动画 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--primary-color);
            border-top: 4px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 奖券卡片动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .coupon-card {
            animation: fadeIn 0.5s ease-out;
        }

        /* 日历动画 */
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .calendar {
            animation: slideIn 0.5s ease-out;
        }
    </style>
</head>
<body class="p-6 md:p-12">
    <!-- 主题切换按钮 -->
    <button id="theme-toggle" class="theme-toggle">
        <span class="light-icon">🌞</span>
        <span class="dark-icon hidden">🌙</span>
    </button>

    <div id="loading-indicator" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container mx-auto max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">楚楚的奖励兑换券们 🎟️✨</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="coupon-card rounded-xl shadow-xl overflow-hidden transition-all duration-300 ease-in-out transform hover:scale-105 bg-gradient-to-tr from-orange-300 to-orange-500 text-white" data-coupon-id="cake" data-coupon-name="小蛋糕券">
                        <div class="emoji-container bg-orange-100">
                            <span class="text-7xl">🍰</span>
                        </div>
                        <div class="p-6 flex flex-col flex-grow">
                            <h2 class="text-xl font-semibold text-white mb-2">小蛋糕券</h2>
                            <p class="text-white text-opacity-90 text-sm mb-4">凭此券可兑换一份美味的小蛋糕。松软香甜，给你带来甜蜜好心情！</p>
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-white font-medium">当前数量:</span>
                                <div class="flex items-center gap-2">
                                    <button class="quantity-change bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold w-6 h-6 rounded-full flex items-center justify-center transition duration-150 ease-in-out" data-action="decrease">-</button>
                                    <span class="quantity-display text-lg font-semibold w-8 text-center text-white">...</span>
                                    <button class="quantity-change bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold w-6 h-6 rounded-full flex items-center justify-center transition duration-150 ease-in-out" data-action="increase">+</button>
                                </div>
                            </div>
                            <button class="use-coupon mt-auto bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out w-full opacity-50 cursor-not-allowed" disabled>
                                使用一张
                            </button>
                        </div>
                    </div>

                    <div class="coupon-card rounded-xl shadow-xl overflow-hidden transition-all duration-300 ease-in-out transform hover:scale-105 flex flex-col" data-coupon-id="salmon" data-coupon-name="三文鱼券">
                        <div class="emoji-container bg-pink-100 rounded-t-xl">
                            <span class="text-7xl">🍣</span>
                        </div>
                        <div class="p-6 flex flex-col flex-grow bg-gradient-to-tr from-pink-300 to-pink-500 text-white rounded-b-xl">
                            <h2 class="text-xl font-semibold text-white mb-2">三文鱼券</h2>
                            <p class="text-white text-opacity-90 text-sm mb-4">凭此券可享受新鲜美味的三文鱼料理。肉质鲜嫩，营养丰富！</p>
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-white font-medium">当前数量:</span>
                                <div class="flex items-center gap-2">
                                    <button class="quantity-change bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold w-6 h-6 rounded-full flex items-center justify-center transition duration-150 ease-in-out" data-action="decrease">-</button>
                                    <span class="quantity-display text-lg font-semibold w-8 text-center text-white">...</span>
                                    <button class="quantity-change bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold w-6 h-6 rounded-full flex items-center justify-center transition duration-150 ease-in-out" data-action="increase">+</button>
                                </div>
                            </div>
                            <button class="use-coupon mt-auto bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out w-full opacity-50 cursor-not-allowed" disabled>
                                使用一张
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 留言板区域 -->
                <div class="mt-6 bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">留言板 💬</h2>
                    
                    <!-- 留言输入表单 -->
                    <div class="mb-6">
                        <div class="flex items-center gap-4 mb-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="speaker" value="楚楚" checked class="form-radio text-blue-500">
                                <span class="text-gray-700">楚楚</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="speaker" value="高老师" class="form-radio text-blue-500">
                                <span class="text-gray-700">高老师</span>
                            </label>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="message-input" placeholder="输入留言..." 
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="send-message" 
                                    class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-300">
                                发送
                            </button>
                        </div>
                    </div>

                    <!-- 留言列表 -->
                    <div id="message-list" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- 留言将通过 JavaScript 动态添加 -->
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">奖券日历 🗓️</h2>
                <div id="calendar-container" class="calendar mb-6">
                    <div class="calendar-header">
                        <button id="prev-month" class="p-1 rounded hover:bg-gray-200">&lt;</button>
                        <span id="current-month-year" class="font-semibold text-lg"></span>
                        <button id="next-month" class="p-1 rounded hover:bg-gray-200">&gt;</button>
                    </div>
                    <div class="calendar-grid" id="calendar-weekdays"></div>
                    <div class="calendar-grid" id="calendar-days"></div>
                </div>
                <h3 class="text-xl font-semibold text-gray-700 mb-3">奖券记录 📝 (<span id="selected-date-display">未选择日期</span>)</h3>
                <div id="log-display-area" class="log-area">
                    <p class="text-gray-500 italic">请在日历中选择一个日期查看奖券记录。</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        // --- Firebase 配置 ---
        const firebaseConfig = {
          apiKey: "AIzaSyBxzlxj-Sva3kVxhsWHI_2BGHJeYPHGS2s",
          authDomain: "tickets-91f95.firebaseapp.com",
          databaseURL: "https://tickets-91f95-default-rtdb.firebaseio.com",
          projectId: "tickets-91f95",
          storageBucket: "tickets-91f95.appspot.com",
          messagingSenderId: "507720843459",
          appId: "1:507720843459:web:d8118e2d4ed09263846276",
          measurementId: "G-BHG904WQPN"
        };

        // --- 初始化 Firebase ---
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- 全局状态 ---
        let currentDate = new Date();
        let selectedDate = null;
        let localActionLogs = {};

        // --- DOM 元素引用 ---
        const couponCards = document.querySelectorAll('.coupon-card');
        const calendarContainer = document.getElementById('calendar-container');
        const calendarDaysGrid = document.getElementById('calendar-days');
        const calendarWeekdaysGrid = document.getElementById('calendar-weekdays');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');
        const logDisplayArea = document.getElementById('log-display-area');
        const selectedDateDisplay = document.getElementById('selected-date-display');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- Firebase 数据库引用 ---
        const couponsRef = database.ref('coupons');
        const logsRef = database.ref('logs');

        // --- 功能函数 ---

        /**
         * 更新奖券数量显示和按钮状态
         * @param {string} couponId - 奖券ID
         * @param {number} quantity - 数量
         */
        function updateQuantityDisplay(couponId, quantity) {
            const card = document.querySelector(`.coupon-card[data-coupon-id="${couponId}"]`);
            if (card) {
                const quantityEl = card.querySelector('.quantity-display');
                const decreaseBtn = card.querySelector('.quantity-change[data-action="decrease"]');
                const useBtn = card.querySelector('.use-coupon');

                const numQuantity = Number(quantity);
                const displayQuantity = isNaN(numQuantity) ? 0 : numQuantity;

                quantityEl.textContent = displayQuantity;
                const disable = displayQuantity <= 0;

                if (decreaseBtn) {
                    decreaseBtn.disabled = disable;
                    decreaseBtn.classList.toggle('opacity-50', disable);
                    decreaseBtn.classList.toggle('cursor-not-allowed', disable);
                }
                if (useBtn) {
                    useBtn.disabled = disable;
                    useBtn.classList.toggle('opacity-50', disable);
                    useBtn.classList.toggle('cursor-not-allowed', disable);
                }
            }
        }

        /**
         * 获取格式化的日期字符串 (YYYY-MM-DD)
         * @param {Date} date - 日期对象
         * @returns {string}
         */
        function getFormattedDate(date) {
            if (!(date instanceof Date) || isNaN(date)) {
                console.error("Invalid date provided to getFormattedDate:", date);
                const today = new Date();
                 const year = today.getFullYear();
                 const month = String(today.getMonth() + 1).padStart(2, '0');
                 const day = String(today.getDate()).padStart(2, '0');
                 return `${year}-${month}-${day}`;
            }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * 记录操作日志到 Firebase
         * @param {string} couponName - 奖券名称
         * @param {string} actionType - 操作类型
         * @param {number} quantityChange - 数量变化
         */
        function logActionToFirebase(couponName, actionType, quantityChange) {
            const todayStr = getFormattedDate(new Date());
            const timeStr = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit'});
            let message = `${timeStr} - `;

            if (actionType === '增加') message += `增加了 ${quantityChange} 个 ${couponName}`;
            else if (actionType === '减少') message += `减少了 ${-quantityChange} 个 ${couponName}`;
            else if (actionType === '使用') message += `使用了 1 个 ${couponName}`;

            const dateLogRef = logsRef.child(todayStr);
            dateLogRef.push({
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                message: message
            }).catch(error => {
                console.error("Error writing log to Firebase:", error);
            });
        }

        /**
         * 处理数量变更按钮点击
         * @param {Event} event
         */
        function handleQuantityChange(event) {
            const button = event.target.closest('.quantity-change');
            if (!button || button.disabled) return;
            const card = button.closest('.coupon-card');
            if (!card) return;
            const couponId = card.dataset.couponId;
            const couponName = card.dataset.couponName;
            const action = button.dataset.action;
            if (!couponId || !couponName) {
                console.error("Missing coupon ID or name on card:", card);
                return;
            }
            const couponQuantityRef = couponsRef.child(couponId).child('quantity');

            couponQuantityRef.transaction(currentQuantity => {
                 let numQuantity = Number(currentQuantity);
                 if (currentQuantity === null || isNaN(numQuantity)) {
                     numQuantity = 0;
                 }
                if (action === 'increase') {
                    return numQuantity + 1;
                } else if (action === 'decrease') {
                    if (numQuantity > 0) {
                        return numQuantity - 1;
                    } else {
                        return; // Abort transaction
                    }
                } else {
                    return; // Abort transaction
                }
            }, (error, committed, snapshot) => {
                if (error) {
                    console.error("Quantity change transaction failed:", error);
                } else if (committed) {
                    let change = 0;
                    let actionType = '';
                    if (action === 'increase') {
                        change = 1;
                        actionType = '增加';
                    } else if (action === 'decrease') {
                        change = -1;
                        actionType = '减少';
                    }
                    if (actionType) {
                         logActionToFirebase(couponName, actionType, change);
                    }
                }
            });
        }

        /**
         * 处理使用奖券按钮点击
         * @param {Event} event
         */
        function handleUseCoupon(event) {
            const button = event.target.closest('.use-coupon');
            if (!button || button.disabled) return;
            const card = button.closest('.coupon-card');
            if (!card) return;
            const couponId = card.dataset.couponId;
            const couponName = card.dataset.couponName;
            if (!couponId || !couponName) {
                console.error("Missing coupon ID or name on card:", card);
                return;
            }
            const couponQuantityRef = couponsRef.child(couponId).child('quantity');

            couponQuantityRef.transaction(currentQuantity => {
                 let numQuantity = Number(currentQuantity);
                 if (currentQuantity === null || isNaN(numQuantity)) {
                     numQuantity = 0;
                 }
                if (numQuantity > 0) {
                    return numQuantity - 1;
                } else {
                    return; // Abort transaction
                }
            }, (error, committed, snapshot) => {
                if (error) {
                    console.error("Use coupon transaction failed:", error);
                } else if (committed) {
                    logActionToFirebase(couponName, '使用', -1);
                }
            });
        }

        // --- 日历渲染和日志显示 ---

        function renderCalendar() {
            calendarDaysGrid.innerHTML = '';
            calendarWeekdaysGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            currentMonthYearEl.textContent = `${year}年${month + 1}月`;

            const weekdays = ['一', '二', '三', '四', '五', '六', '日'];
            weekdays.forEach(day => {
                const weekdayEl = document.createElement('div');
                weekdayEl.classList.add('calendar-weekday');
                weekdayEl.textContent = day;
                calendarWeekdaysGrid.appendChild(weekdayEl);
            });

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            let startDayOfWeek = firstDayOfMonth.getDay();
            startDayOfWeek = (startDayOfWeek === 0) ? 6 : startDayOfWeek - 1;

            const today = new Date();
            const todayStr = getFormattedDate(today);

            const lastDayOfPrevMonth = new Date(year, month, 0);
            const daysInPrevMonth = lastDayOfPrevMonth.getDate();
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const date = new Date(year, month - 1, day);
                const dateStr = getFormattedDate(date);
                const dayEl = createDayElement(day, dateStr, ['other-month']);
                calendarDaysGrid.appendChild(dayEl);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = getFormattedDate(date);
                const classes = [];
                if (dateStr === todayStr) classes.push('today');
                if (dateStr === selectedDate) classes.push('selected');
                if (localActionLogs[dateStr] && localActionLogs[dateStr].length > 0) classes.push('has-log');
                const dayEl = createDayElement(day, dateStr, classes);
                calendarDaysGrid.appendChild(dayEl);
            }

            const totalCells = calendarDaysGrid.children.length;
            const nextMonthDaysNeeded = 42 - totalCells;
            for (let i = 1; i <= nextMonthDaysNeeded; i++) {
                 const date = new Date(year, month + 1, i);
                 const dateStr = getFormattedDate(date);
                 const dayEl = createDayElement(i, dateStr, ['other-month']);
                 calendarDaysGrid.appendChild(dayEl);
            }
        }

        function createDayElement(dayNumber, dateStr, classes = []) {
            const dayEl = document.createElement('div');
            dayEl.classList.add('calendar-day', ...classes);
            dayEl.textContent = dayNumber;
            dayEl.dataset.date = dateStr;
            if (!classes.includes('other-month')) {
                dayEl.addEventListener('click', handleDateClick);
            }
            return dayEl;
        }

        function handleDateClick(event) {
            const clickedDateStr = event.target.dataset.date;
            if (!clickedDateStr) return;
            selectedDate = clickedDateStr;
            selectedDateDisplay.textContent = clickedDateStr;
            renderCalendar();
            displayLogsForDate(clickedDateStr);
        }

        function displayLogsForDate(dateStr) {
            logDisplayArea.innerHTML = '';
            const logs = localActionLogs[dateStr];
            if (logs && logs.length > 0) {
                const sortedLogs = [...logs].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                sortedLogs.forEach(logData => {
                    if (logData && logData.message) {
                        const logEl = document.createElement('div');
                        logEl.classList.add('log-entry');
                        logEl.textContent = logData.message;
                        logDisplayArea.appendChild(logEl);
                    }
                });
            } else {
                logDisplayArea.innerHTML = '<p class="text-gray-500 italic">这一天没有奖券记录。</p>';
            }
        }

        // --- Firebase 数据监听 ---

        function listenToCouponChanges() {
            couponsRef.on('value', (snapshot) => {
                loadingIndicator.style.display = 'flex';
                const couponsData = snapshot.val();
                if (couponsData) {
                    Object.keys(couponsData).forEach(couponId => {
                        const card = document.querySelector(`.coupon-card[data-coupon-id="${couponId}"]`);
                        if (card) {
                            const quantity = couponsData[couponId]?.quantity ?? 0;
                            updateQuantityDisplay(couponId, quantity);
                        } else {
                            console.warn(`Coupon data found for ID "${couponId}", but no matching card element.`);
                        }
                    });
                    couponCards.forEach(card => {
                        const couponId = card.dataset.couponId;
                        if (couponId && (!couponsData || !couponsData[couponId])) {
                             console.log(`Initializing missing coupon "${couponId}" in Firebase.`);
                             couponsRef.child(couponId).set({
                                 name: card.dataset.couponName || `Unnamed Coupon ${couponId}`,
                                 quantity: 0
                             }).catch(error => console.error(`Error initializing coupon ${couponId}:`, error));
                             updateQuantityDisplay(couponId, 0);
                        }
                    });
                } else {
                    console.log("No 'coupons' data found in Firebase. Initializing...");
                    const initialCoupons = {};
                    couponCards.forEach(card => {
                        const couponId = card.dataset.couponId;
                        const couponName = card.dataset.couponName;
                        if (couponId && couponName) {
                            initialCoupons[couponId] = { name: couponName, quantity: 0 };
                        }
                    });
                    couponsRef.set(initialCoupons).then(() => {
                         console.log("Initial coupon data set.");
                         Object.keys(initialCoupons).forEach(id => updateQuantityDisplay(id, 0));
                    }).catch(error => console.error("Error setting initial coupons:", error));
                }
                 loadingIndicator.style.display = 'none';
            }, (error) => {
                console.error("Firebase coupon data read failed:", error);
                loadingIndicator.textContent = '加载奖券数据失败，请检查网络或配置。';
            });
        }

        function listenToLogChanges() {
            logsRef.on('value', (snapshot) => {
                const logsData = snapshot.val();
                localActionLogs = {};
                if (logsData) {
                    Object.keys(logsData).forEach(dateStr => {
                        const dateLogsFirebase = logsData[dateStr];
                        if (dateLogsFirebase && typeof dateLogsFirebase === 'object') {
                            localActionLogs[dateStr] = Object.values(dateLogsFirebase);
                        }
                    });
                }
                renderCalendar();
                if (selectedDate) {
                    displayLogsForDate(selectedDate);
                }
            }, (error) => {
                console.error("Firebase log data read failed:", error);
            });
        }

        // --- 初始化与事件监听 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadingIndicator.style.display = 'flex';
            listenToCouponChanges();
            listenToLogChanges();

            const couponsContainer = document.querySelector('.lg\\:col-span-2 .grid');
             if (couponsContainer) {
                 couponsContainer.addEventListener('click', (event) => {
                    const quantityButton = event.target.closest('.quantity-change');
                    if (quantityButton) {
                        handleQuantityChange(event);
                        return;
                    }
                    const useButton = event.target.closest('.use-coupon');
                    if (useButton) {
                        handleUseCoupon(event);
                        return;
                    }
                });
             }

            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

             renderCalendar();
            selectedDateDisplay.textContent = '未选择日期';
            logDisplayArea.innerHTML = '<p class="text-gray-500 italic">请在日历中选择一个日期查看奖券记录。</p>';

            // 主题切换功能
            const themeToggle = document.getElementById('theme-toggle');
            const lightIcon = themeToggle.querySelector('.light-icon');
            const darkIcon = themeToggle.querySelector('.dark-icon');
            
            // 检查本地存储中的主题设置
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // 更新图标显示
            if (savedTheme === 'dark') {
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
            }

            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // 切换图标显示
                lightIcon.classList.toggle('hidden');
                darkIcon.classList.toggle('hidden');
            });

            // 留言板功能
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-message');
            const messageList = document.getElementById('message-list');
            const messagesRef = database.ref('messages');

            // 发送留言
            function sendMessage() {
                const message = messageInput.value.trim();
                const speaker = document.querySelector('input[name="speaker"]:checked').value;
                
                if (!message) {
                    alert('请输入留言内容');
                    return;
                }

                messagesRef.push({
                    speaker: speaker,
                    message: message,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    messageInput.value = '';
                }).catch(error => {
                    console.error("Error sending message:", error);
                    alert('发送失败，请重试');
                });
            }

            // 发送回复
            function sendReply(messageId, replyInput) {
                const reply = replyInput.value.trim();
                const speaker = document.querySelector('input[name="speaker"]:checked').value;
                
                if (!reply) {
                    alert('请输入回复内容');
                    return;
                }

                const replyRef = messagesRef.child(messageId).child('replies');
                replyRef.push({
                    speaker: speaker,
                    message: reply,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    replyInput.value = '';
                    const replyContainer = replyInput.closest('.reply-container');
                    if (replyContainer) {
                        replyContainer.classList.add('hidden');
                    }
                }).catch(error => {
                    console.error("Error sending reply:", error);
                    alert('发送失败，请重试');
                });
            }

            // 添加发送按钮点击事件
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // 渲染留言
            function displayMessage(messageData, messageId) {
                // 容错处理
                const speaker = messageData.speaker || '未知';
                const message = messageData.message || '';
                const timestampValue = messageData.timestamp;
                let timestamp = '未知时间';
                if (timestampValue && !isNaN(Number(timestampValue))) {
                    timestamp = new Date(Number(timestampValue)).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = 'bg-gray-50 p-4 rounded-lg';
                messageDiv.dataset.messageId = messageId;
                
                // 创建回复按钮
                const replyButton = document.createElement('button');
                replyButton.className = 'text-sm text-blue-500 hover:text-blue-600 transition duration-300';
                replyButton.textContent = '回复';
                replyButton.addEventListener('click', () => {
                    const replyContainer = messageDiv.querySelector('.reply-container');
                    replyContainer.classList.toggle('hidden');
                });

                // 创建删除按钮
                const deleteButton = document.createElement('button');
                deleteButton.className = 'text-sm text-red-500 hover:text-red-600 transition duration-300 ml-2';
                deleteButton.textContent = '删除';
                deleteButton.addEventListener('click', () => {
                    if (confirm('确定要删除这条留言吗？')) {
                        messagesRef.child(messageId).remove()
                            .catch(error => {
                                console.error("Error deleting message:", error);
                                alert('删除失败，请重试');
                            });
                    }
                });

                // 创建回复输入框容器
                const replyContainer = document.createElement('div');
                replyContainer.className = 'reply-container hidden mt-2 pl-4 border-l-2 border-gray-200';
                
                const replyInput = document.createElement('input');
                replyInput.type = 'text';
                replyInput.placeholder = '输入回复...';
                replyInput.className = 'w-full px-3 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm';
                
                const replyButtonContainer = document.createElement('div');
                replyButtonContainer.className = 'flex justify-end mt-2 gap-2';
                
                const sendReplyButton = document.createElement('button');
                sendReplyButton.className = 'px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-300 text-sm';
                sendReplyButton.textContent = '发送';
                sendReplyButton.addEventListener('click', () => sendReply(messageId, replyInput));
                
                const cancelButton = document.createElement('button');
                cancelButton.className = 'px-3 py-1 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-300 text-sm';
                cancelButton.textContent = '取消';
                cancelButton.addEventListener('click', () => {
                    replyContainer.classList.add('hidden');
                    replyInput.value = '';
                });

                replyButtonContainer.appendChild(sendReplyButton);
                replyButtonContainer.appendChild(cancelButton);
                
                replyContainer.appendChild(replyInput);
                replyContainer.appendChild(replyButtonContainer);

                // 创建回复列表容器
                const repliesContainer = document.createElement('div');
                repliesContainer.className = 'replies-container mt-2 space-y-2';
                
                // 如果有回复，显示回复
                if (messageData.replies) {
                    Object.entries(messageData.replies).forEach(([replyId, replyData]) => {
                        const replyDiv = createReplyElement(replyData, messageId, replyId);
                        repliesContainer.appendChild(replyDiv);
                    });
                }

                messageDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-semibold ${speaker === '楚楚' ? 'text-pink-500' : 'text-blue-500'}">${speaker}</span>
                        <span class="text-sm text-gray-500">${timestamp}</span>
                    </div>
                    <p class="text-gray-700">${message}</p>
                    <div class="flex justify-end mt-2">
                    </div>
                `;

                const buttonContainer = messageDiv.querySelector('.flex.justify-end');
                buttonContainer.appendChild(replyButton);
                buttonContainer.appendChild(deleteButton);
                
                messageDiv.appendChild(repliesContainer);
                messageDiv.appendChild(replyContainer);
                messageList.appendChild(messageDiv);
                messageList.scrollTop = messageList.scrollHeight;
            }

            // 渲染回复
            function createReplyElement(replyData, messageId, replyId) {
                const speaker = replyData.speaker || '未知';
                const message = replyData.message || '';
                const timestampValue = replyData.timestamp;
                let timestamp = '未知时间';
                if (timestampValue && !isNaN(Number(timestampValue))) {
                    timestamp = new Date(Number(timestampValue)).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }

                const replyDiv = document.createElement('div');
                replyDiv.className = 'bg-gray-100 p-3 rounded-lg ml-4';
                replyDiv.dataset.replyId = replyId;
                
                // 创建删除按钮
                const deleteButton = document.createElement('button');
                deleteButton.className = 'text-xs text-red-500 hover:text-red-600 transition duration-300 ml-2';
                deleteButton.textContent = '删除';
                deleteButton.addEventListener('click', () => {
                    if (confirm('确定要删除这条回复吗？')) {
                        messagesRef.child(messageId).child('replies').child(replyId).remove()
                            .catch(error => {
                                console.error("Error deleting reply:", error);
                                alert('删除失败，请重试');
                            });
                    }
                });

                replyDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-semibold ${speaker === '楚楚' ? 'text-pink-500' : 'text-blue-500'}">${speaker}</span>
                        <div class="flex items-center">
                            <span class="text-xs text-gray-500">${timestamp}</span>
                        </div>
                    </div>
                    <p class="text-gray-700 text-sm">${message}</p>
                `;

                const timestampContainer = replyDiv.querySelector('.flex.items-center');
                timestampContainer.appendChild(deleteButton);

                return replyDiv;
            }

            // 只保留 child_added 和 child_changed 监听，不要用 once('value') 全量渲染
            messageList.innerHTML = ''; // 每次页面加载时清空
            messagesRef.off(); // 先移除所有监听，防止多次绑定

            messagesRef.on('child_added', (snapshot) => {
                const messageData = snapshot.val();
                const messageId = snapshot.key;
                displayMessage(messageData, messageId);
            });

            messagesRef.on('child_changed', (snapshot) => {
                const messageData = snapshot.val();
                const messageId = snapshot.key;
                const messageDiv = document.querySelector(`[data-message-id=\"${messageId}\"]`);
                if (messageDiv) {
                    const repliesContainer = messageDiv.querySelector('.replies-container');
                    repliesContainer.innerHTML = '';
                    if (messageData.replies) {
                        Object.entries(messageData.replies).forEach(([replyId, replyData]) => {
                            const replyDiv = createReplyElement(replyData, messageId, replyId);
                            repliesContainer.appendChild(replyDiv);
                        });
                    }
                }
            });
        });

        // 更新加载指示器样式
        loadingIndicator.innerHTML = '<div class="loading-spinner"></div>';
    </script>

</body>
</html>
